#!/usr/bin/perl
use Modern::Perl '2014';
use experimental 'signatures';

our @SOURCES = qw(NIST PAPERS);
our @METRICS = qw(
  acc
  accm
  amloc
  an
  anpm
  asom
  auv
  bd
  bf
  cbo
  da
  dbz
  df
  dit
  dnp
  dupv
  fgbo
  lcom4
  loc
  mlk
  mmloc
  noa
  noc
  nom
  npa
  npm
  obaa
  osf
  pitfc
  rfc
  rogu
  rsva
  saigv
  sc
  ua
  uaf
  uav
);

sub metrics_by_module($file, @metrics) {
  my $table = ();
  my $i = -1;
  open my $FILE, '<', $file;
  my $_metrics = join '|', @metrics;
  while(my $line = <$FILE>) {
    if ($line =~ m/^_module: (.+)/) {
      $i++;
      push @{ $table->[$i] }, $1;
    }
    if ($line =~ m/^(?:$_metrics): (.+)/) {
      push @{ $table->[$i] }, $1;
    }
  }
  close $FILE;
  return @{ $table };
}

foreach my $source (@SOURCES) {
  foreach my $tool (grep { -d $_ } glob("$ENV{PWD}/$source/*")) {
    foreach my $dir (grep { -d $_ } glob("$tool/*")) {
      unless (-e "$dir.doxyparse") {
        say "doxyparse $dir > $dir.doxyparse";
        `doxyparse $dir > $dir.doxyparse`;
      }
      unless (-e "$dir.analizo.metrics") {
        say "analizo metrics $dir > $dir.analizo.metrics";
        `analizo metrics $dir > $dir.analizo.metrics`;
      }
      unless (-e "$dir.sloccount") {
        say "sloccount $dir > $dir.sloccount";
        `sloccount $dir > $dir.sloccount`;
      }
    }
  }
}

foreach my $source (@SOURCES) {
  foreach my $file (glob("./$source/*/*.metrics")) {
    unless (-e "$file.dat") {
      open my $OUTPUT, '>', "$file.dat";
      say "+ $file -> $file.dat";
      say $OUTPUT "@METRICS";
      foreach my $row (metrics_by_module($file, @METRICS)) {
        say $OUTPUT "@{ $row }";
      }
      close $OUTPUT;
    }
  }
}
