#!/usr/bin/perl
use utf8;
use open ':locale';
use Modern::Perl '2014';
use Text::BibTeX ':subs';
use List::Util qw( all );
use lib 'lib';
use Dissertacao qw( equal foreach_bibtex_file );

=head1 NAME

query - count unique references satisfying some constraint

=cut

my %constraints = split(/=/, pop @ARGV);
my @FILES = @ARGV;
my %uniq = ();

foreach_bibtex_file(@FILES, sub {
  my $entry = shift;
  unless (grep { equal($entry, $uniq{$_}) } keys %uniq) {
    if (all { $entry->get($_) && $entry->get($_) eq $constraints{$_} } keys %constraints) {
      $uniq{$entry->key} = $entry;
      #print $entry->print_s;
    }
  }
});

say scalar keys %uniq;
